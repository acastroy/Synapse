<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Synapse pong demo</title>

	<script type="text/javascript" src="synapse.js"></script>

	<script type="text/javascript">


		var currentGameId=0;
		var myX=0;
		var myY=0;
		var myXYchanged=true;
	
		/// SYNAPSE EVENT HANDLERS
 		synapse_register("pong_GameStatus",function(msg_src, msg_dst, msg_event, msg)
 		{
			if ($("#gameList #"+msg["id"]).length==0)
			{
				//add to gamelist
				var html="<div class='game' id='"+msg["id"]+"'>";
				html+="</div>";
				$('#gameList').append(html);

				//make it clickable
				$("#"+msg["id"]).click(function()
						{
							send(0,"pong_JoinGame", {
									"name":$("#name").val(),
									"id":$(this).attr('id'),
								});
						});
			}

			//create the html with the actual game info:
			var html="Game of " + msg["name"]  + " (#" +msg["id"] + "):";
			for (var playerI in msg["players"])
			{
				html+="<div class='playerInfo'>";
				html+=msg["players"][playerI];
				html+="</div>";
			}

			$("#gameList #"+msg["id"]).html(html);
		});

 		synapse_register("pong_GameDeleted",function(msg_src, msg_dst, msg_event, msg)
		{
 			$("#gameList #"+msg["id"]).remove();
		});
 				

		synapse_register("pong_GameJoined",function(msg_src, msg_dst, msg_event, msg)
		{	
			currentGameId=msg["id"];
			//clear up the old gamefield.
			$("#gameField .pad").remove();
		});

		synapse_register("pong_RunStep",function(msg_src, msg_dst, msg_event, msg)
		{	
			//ball xy
			var x=Math.round((msg[0]*$("#gameField").width())/10000);
			var y=Math.round((msg[1]*$("#gameField").height())/10000);
			$(".ball").css('left',x).css('top',y);

			i=2;
			while(i<msg.length)
			{
				var id=msg[i+0];
				var x=Math.round((msg[i+1]*$("#gameField").width())/10000);
				var y=Math.round((msg[i+2]*$("#gameField").height())/10000);

				
				var object=$("#gameField #"+id);
				if (object.length==0)
				{
					//add pad
					$("#gameField").append("<div class='pad' id='" + id + "'></div>");
					object=$("#gameField #"+id);
				}
				
				object.css('left',x).css('top',y);
				i=i+3;
			}

			if (myXYchanged && currentGameId)
			{
				//the field is always 10000x10000 pixels.
				send(0,"pong_SetPosition", {
					"id":currentGameId,
					"x":Math.round((myX * 10000) / $("#gameField").width()),
					"y":Math.round((myY * 10000) / $("#gameField").height())							
				});
				myXYchanged=false;
			}

		});

		
 		synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
			send(0,"pong_GetGames", { 
			});

			/// JAVA SCRIPT EVENT HANDLERS
			$("#newGame").click(function()
					{
						send(0,"pong_NewGame", {
								"name":$("#name").val()
							});
					});
//				$("#getGames").click(function()
//					{
//						$('.game').remove();
//						send(0,"pong_GetGames", {});
//					});

			

			$("#gameFieldMouse").mousemove(function(m)
					{
						myX=m.layerX;
						myY=m.layerY;
						myXYchanged=true;
//						console.info(m.layerX ,",",m.layerY, "=>" ,x, ",", y);
						
					});
 		});




	</script>

	<style>
		body 
		{
			margin:0;
			padding:0;
			height:100%;
		} 


		.color1  { color: #ff0000; } 
		.color2  { color: #00ff00; } 
		.color3  { color: #0000ff; } 
		.color4  { color: #ffff00; } 
		.color5  { color: #ff00ff; } 
		.color6  { color: #00ffff; } 
		.color7  { color: #aaff00; } 
		.color8  { color: #00ffaa; } 
		.color9  { color: #aa00aa; } 
		.color10 { color: #aa00ff; } 

		.playerInfo
		{
			width:18em;
			background:yellow;
			margin-left:1em;
		}

		#gameManager
		{
			position:absolute; 
			left:0;
			top: 0;
			width: 20em;
			bottom:0;
			border-style:solid;
		}

		#gameField
		{
			position:absolute; 
			left:20em;
			top: 0;
			right: 0;
			bottom:0;
			border-style:solid;
			border-color:#00ff00;
			border-width:0;
			background:black;
			
			
		}

		#gameFieldMouse
		{
			position:absolute; 
			left:20em;
			top: 0;
			right: 0;
			bottom:0;
		}
		
		#gameFieldMiddle
		{
			position:absolute;
			left:50%;
			top:0;
			bottom:0;
			border-style:dashed;
			border-color:#00ff00;
		}

		.score
		{
			color: #00ff00;
			font-size:2em;
			font-family: monospace;
			font-weight: bold;
		}

		#scoreLeft
		{
			position:absolute;
			left:40%;
			top:1em;
		}
		
		#scoreRight
		{
			position:absolute;
			left:60%;
			top:1em;
		}

		.pad
		{
			position:absolute;
			left:10%;
			top:10%;
			width:1%;
			height:10%;
			background-color:#00ff00;
		}

		.ball
		{
			position:absolute;
			left:30%;
			top:30%;
			width:1%;
			height:2%;
			background-color:#00ff00;
		}
		
	</style>

</head>


<body class='ui-widget'>
	<p>

	<div class='ui-widget-content' id='gameManager'>
		<div class='ui-widget-header'>Your name:</div>
		<input id='name' type='text' value=''>

		<div class='ui-widget-header'>Available games:</div>
		Click to join...
		<div id='gameList'></div>
		<input id='newGame' type='submit' value='New game'>
	</div>




	<div id='gameField'>
		<div id='gameFieldMiddle'></div>
		<div class='score' id='scoreLeft'>15</div>
		<div class='score' id='scoreRight'>2</div>
		<div class='ball'></div>		
		
	</div>

	<div id='gameFieldMouse'>
	</div>

	
</body>
</html>