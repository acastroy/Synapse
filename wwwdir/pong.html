<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Synapse pong demo</title>

	<script type="text/javascript" src="synapse.js"></script>

	<script type="text/javascript">

		//global time, updated every frame. This is to lower the number of calls to Date().gettime and to get time-consistency.
		currentTime=0;
	
		//this is the class to store position information in.
		//position information is always a combination of x,y coordinates and x,y speed.
		//In combination with timing we can calculate the predicted position.
		function Cposition() {
			this.x=0;
			this.y=0;
			this.xSpeed=0;
			this.ySpeed=0;
			this.startTime=0;
			this.duration=0;

			//duration is in S
			//Speeds in pixels per S.
			this.set=function(newX, newY, newXspeed, newYspeed, duration)
			{
				if (typeof duration !== 'undefined')
					this.duration=duration;
				this.x=newX;
				this.y=newY;
				this.xSpeed=newXspeed;
				this.ySpeed=newYspeed;
				this.startTime=currentTime;
			}

			//move smootly from current position to new position
			//duration in S.
			this.move=function(newX, newY, duration)
			{
				//get current calculated position
				p=this.get();
				//move from there to the new position in duration S.
				this.set(p.x, p.y, ((newX-p.x)/duration), ((newY-p.y)/duration), duration);  
			}

			
			//calculate the current x and y coordinates, based on the start position, start time, x,y-speeds and current time.
			this.get=function()
			{
				var duration=(currentTime-this.startTime)/1000;
				if (this.duration && duration>this.duration)
					duration=this.duration;
				return {
					x: this.x+((this.xSpeed*duration)),
					y: this.y+((this.ySpeed*duration)),
					xSpeed: this.xSpeed,
					ySpeed: this.ySpeed,
					duration: duration
				};
			}								
		}
		
		//calculate browser coordinates to game coordinates
		function browser2game(x,y)
		{
			return {
				x:Math.round((x * 10000) / $("#gameField").width()),
				y:Math.round((y * 10000) / $("#gameField").height())
			}
		}

		//calculate game coordinates to browser coordinates
		function game2browser(x,y)
		{
			return {
				x: Math.round((x*$("#gameField").width())/10000),
				y: Math.round((y*$("#gameField").height())/10000)
			}
		}

		
		var updateInterval=25; //update inteval in mS
		var mouseSkip=4;       //nr of mouse position sends to skip 
		
		var currentGameId=0;

		//variables to predict mouse movement
		var mouseX=0; //current mouse position
		var mouseY=0;
		var mouseXold=0; //mouse position, speed and time during last snapshot
		var mouseYold=0;
		var mouseTime=0;
		var mouseCount=0;
		
		var ballPosition=new Cposition();

		var padPositions=new Array();

		
		function updateGameField()
		{
			//update global time variable. 
			currentTime=new Date().getTime();

			//send mouse update to server?
			mouseCount++;
			if (mouseCount>mouseSkip)
			{
				mouseCount=0;

				//mouse actually changed?
				if (mouseX!=mouseXold || mouseY!=mouseYold)
				{
					//convert coordinates and send out destination position + time it took to get there.
					pos=browser2game(mouseX, mouseY);
					send(0,"pong_SetPosition", [pos.x, pos.y, (currentTime-mouseTime)/1000] );

					mouseXold=mouseX;
					mouseYold=mouseY;
				}

				//always update mouse time!
				mouseTime=currentTime;
			}
		
			//update local pad?
			if (mouseX!=mouseXold || mouseY!=mouseYold)
			{
				$(".padLocal").css('left',mouseX).css('top',mouseY);
			}

				
			///////////////////////////////////// Ball and pad movements 

			//move ball:
			var pos=ballPosition.get();
			$(".ball").css('left',pos.x).css('top',pos.y);

			//move pads:
			for (padI in padPositions)
			{
				var object=$("#gameField #"+padI);
				if (object.length==0)
				{
					//add pad
					$("#gameField").append("<div class='padPlayer' id='"+padI+"'></div>");
					object=$("#gameField #"+padI);					
				}
				var pos=padPositions[padI].get();
				object.css('left',pos.x).css('top',pos.y);
			}
		};

		//here is where we receive the positions of the ball and pads from the server.
		//We just store the information in Cposition objects. The actual calculation and drawing is done in UpdateGameField().
		synapse_register("pong_Positions",function(msg_src, msg_dst, msg_event, msg)
		{	
			//update global time variable. 
			currentTime=new Date().getTime();

			//(positions are in a plain array for speed optimisation)
			
			//the ball is always first and has id 0
			if (msg[0]==0)
			{
				//ball xy
				pos=game2browser(msg[1], msg[2]);
				speed=game2browser(msg[3], msg[4]);				
				ballPosition.set(pos.x, pos.y, speed.x, speed.y);
				i=5;
			}
			else
			{
				i=0
			}
			
			while(i<msg.length)
			{
				id=msg[i];
				if (padPositions[id]==undefined)
				{
					padPositions[id]=new Cposition();
				}
				pos=game2browser(msg[i+1], msg[i+2]);
				padPositions[id].move(pos.x, pos.y, msg[i+3]);
				i=i+4;		
			}
		});


		
		/// SYNAPSE EVENT HANDLERS
 		synapse_register("pong_GameStatus",function(msg_src, msg_dst, msg_event, msg)
 		{
			if ($("#gameList #"+msg["id"]).length==0)
			{
				//add to gamelist
				var html="<div class='game' id='"+msg["id"]+"'>";
				html+="</div>";
				$('#gameList').append(html);

				//make it clickable
				$("#"+msg["id"]).click(function()
						{
							send(0,"pong_JoinGame", {
									"name":$("#name").val(),
									"id":$(this).attr('id'),
								});
						});
			}

			//create the html with the actual game info:
			var html="Game of " + msg["name"]  + " (#" +msg["id"] + "):";
			for (var playerI in msg["players"])
			{
				html+="<div class='playerInfo'>";
				html+=msg["players"][playerI];
				html+="</div>";
			}

			$("#gameList #"+msg["id"]).html(html);
		});

 		synapse_register("pong_GameDeleted",function(msg_src, msg_dst, msg_event, msg)
		{
 			$("#gameList #"+msg["id"]).remove();
		});
 				

		synapse_register("pong_GameJoined",function(msg_src, msg_dst, msg_event, msg)
		{	
			currentGameId=msg["id"];
			//clear up the old gamefield.
			$("#gameField .pad").remove();
		});


		
		
		
		
 		synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
			send(0,"pong_GetGames", { 
			});

			/// start local engine
			window.setInterval(updateGameField, updateInterval);

			
			/// JAVA SCRIPT EVENT HANDLERS
			$("#newGame").click(function()
					{
						send(0,"pong_NewGame", {
								"name":$("#name").val()
							});
					});
//				$("#getGames").click(function()
//					{
//						$('.game').remove();
//						send(0,"pong_GetGames", {});
//					});



			$("#gameFieldMouse").mousemove(function(m)
			{
				mouseX=m.pageX-$("#gameFieldMouse").offset().left;
				mouseY=m.pageY-$("#gameFieldMouse").offset().top;
			});
 		});




	</script>

	<style>
		body 
		{
			margin:0;
			padding:0;
			height:100%;
		} 


		.color1  { color: #ff0000; } 
		.color2  { color: #00ff00; } 
		.color3  { color: #0000ff; } 
		.color4  { color: #ffff00; } 
		.color5  { color: #ff00ff; } 
		.color6  { color: #00ffff; } 
		.color7  { color: #aaff00; } 
		.color8  { color: #00ffaa; } 
		.color9  { color: #aa00aa; } 
		.color10 { color: #aa00ff; } 

		.playerInfo
		{
			width:18em;
			background:yellow;
			margin-left:1em;
		}

		#gameManager
		{
			position:absolute; 
			left:0;
			top: 0;
			width: 20em;
			bottom:0;
			border-style:solid;
		}

		#gameField
		{
			position:absolute; 
			left:20em;
			top: 0;
			right: 0;
			bottom:0;
			border-style:solid;
			border-color:#00ff00;
			border-width:0;
			background:black;
			overflow:hidden;
		}

		#gameFieldMouse
		{
			position:absolute; 
			left:20em;
			top: 0;
			right: 0;
			bottom:0;
		}
		
		#gameFieldMiddle
		{
			position:absolute;
			left:50%;
			top:0;
			bottom:0;
			border-style:dashed;
			border-color:#00ff00;
		}

		.score
		{
			color: #00ff00;
			font-size:2em;
			font-family: monospace;
			font-weight: bold;
		}

		#scoreLeft
		{
			position:absolute;
			left:40%;
			top:1em;
		}
		
		#scoreRight
		{
			position:absolute;
			left:60%;
			top:1em;
		}

		.padLocal
		{
			position:absolute;
			left:10%;
			top:10%;
			width:1%;
			height:10%;
			background-color:#ffffff;
		}


		.padDebugEst
		{
			position:absolute;
			left:10%;
			top:10%;
			width:1%;
			height:10%;
			border-color: red;
			border-style:solid;
		}

		.padDebugStart
		{
			position:absolute;
			left:10%;
			top:10%;
			width:1%;
			height:10%;
			border-color: yellow;
			border-style:solid;
		}
		
		.padPlayer
		{
			position:absolute;
			left:10%;
			top:10%;
			width:1%;
			height:10%;
			background-color:#00ff00;
		}

		.ball
		{
			position:absolute;
			left:30%;
			top:30%;
			width:1%;
			height:2%;
			background-color:#00ff00;
		}
		
	</style>

</head>


<body class='ui-widget'>
	<p>

	<div class='ui-widget-content' id='gameManager'>
		<div class='ui-widget-header'>Your name:</div>
		<input id='name' type='text' value=''>

		<div class='ui-widget-header'>Available games:</div>
		Click to join...
		<div id='gameList'></div>
		<input id='newGame' type='submit' value='New game'>
	</div>




	<div id='gameField'>
		<div id='gameFieldMiddle'></div>
		<div class='score' id='scoreLeft'>15</div>
		<div class='score' id='scoreRight'>2</div>
		<div class='ball'></div>		
		<div class='padLocal'></div>		
		
	</div>

	<div id='gameFieldMouse'>
	</div>

	
</body>
</html>