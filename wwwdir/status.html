<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Synapse status page</title>

	<script type="text/javascript" src="synapse.js"></script>

	<script type="text/javascript">

		/// SYNAPSE EVENT HANDLERS

		synapse_register("error",function(errortxt)
		{
			$('#error').html(errortxt);
		});	
				
		synapse_register("Xdefault",function(msg_src, msg_dst, msg_event, msg)
		{
			var msgStr="(undefined)";
			if (typeof msg != "undefined")
			{
				msgStr=JSON.stringify(msg);
			}

			$('#broadcastLog').append(
				"<pre>From: "+msg_src+
				" To:"+msg_dst+
				" Event:"+msg_event+
				"\n"+msgStr+"</pre>");

			var objDiv = document.getElementById("broadcastLog");
			objDiv.scrollTop = objDiv.scrollHeight;

		});

		function getupdate()
		{
 			window.setTimeout(function(){
				send(1,"core_GetStatus", { 
					"queue": 1,
					"verbose": 0
				});				
	
				send(0,"http_json_GetStatus", { 
				});
 			},1000);			
		}

		var statCallsTotal=0;
		var cpsMax=0;
		var statSends=0;
		var spsMax=0;
		var lastTime=0;
 		synapse_register("core_Status",function(msg_src, msg_dst, msg_event, msg)
 		{
			getupdate();
			var currentTime=new Date().getTime();

			//calls per second
			var cps=Math.round(((msg["statCallsTotal"]-statCallsTotal)*1000)/(currentTime-lastTime));
			if (cps>cpsMax)
				cpsMax=cps;
			statCallsTotal=msg["statCallsTotal"];
			$('#callsBar').progressbar("option", "value", cps/cpsMax*100);
			$('#callsValue').html("Calls: "+ cps + "/" + cpsMax);

			//sends per second
			var sps=Math.round(((msg["statSends"]-statSends)*1000)/(currentTime-lastTime));
			if (sps>spsMax)
				spsMax=sps;
			statSends=msg["statSends"];
			$('#sendsBar').progressbar("option", "value", sps/spsMax*100);
			$('#sendsValue').html("Sends: "+ sps + "/" + spsMax);
			

			lastTime=currentTime;
			
		
			$('#queueBar').progressbar("option", "value", msg["statCallsQueued"]/msg["statCallsQueuedMax"]*100);
			$('#queueValue').html(
				"Queued: "+ msg["statCallsQueued"]+
				"/"+msg["statCallsQueuedMax"]);

			$('#threadValue').html("Threads: "+msg["activeThreads"]+"/"+msg["statMaxThreads"]);
			$('#threadBar').progressbar("option", "value", msg["activeThreads"]/msg["statMaxThreads"]*100);

			$('#sessionValue').html("Sessions: "+msg["activeSessions"]+"/"+msg["statMaxSessions"]);
			$('#sessionBar').progressbar("option", "value", msg["activeSessions"]/msg["statMaxSessions"]*100);
			
 			$('#core_Status').html(
				"Call queue:\n"+msg["callMan"]+"\nThreads:\n"+msg["threads"]+"\nSessions:\n"+msg["userMan"]
			);

 			$('#sessions').empty();
			for (var session in msg["sessions"])
			{
				var html="<div>";
				html+=msg["sessions"][session]["id"]+": ";
				html+=msg["sessions"][session]["user"]+"@"+msg["sessions"][session]["module"];
				html+=" <i>"+msg["sessions"][session]["desc"]+"</i>";
				html+="<br>Sends: "+msg["sessions"][session]["statSends"]+" Recvs:"+msg["sessions"][session]["statCalls"];
				html+="</div>";
				$('#sessions').append(html);
			}

 			$('#queue').empty();
			for (var call in msg["queue"])
			{
				var html;
				var m=msg["queue"][call];
				if (m["running"]==1)
					html="<div class='running'>Running ";
				else
					html="<div class='queued'>Queued ";

				html+="<i>"+m["event"]+"</i> ";
				html+="from <i>"+m["src"]+"</i> ";
				html+="to <i>"+m["dst"]+":"+m["dstUserName"]+"@"+m["dstModule"]+"</i> ";
				html+="<pre>"+JSON.stringify(m["data"],null," ")+"</pre>";
				html+="</div>";
				$('#queue').append(html);
			}
			
			
 		});

 		synapse_register("http_json_Status",function(msg_src, msg_dst, msg_event, msg)
 		{
 			$('#http_json_Status').html(
				"Network status:\n"+msg["net"] + "\nHTTP sessions:\n"+msg["httpSessionMan"]

			);
 		});


 		synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
			$('.bar').progressbar();
			
 			$('#authCookie').html(msg["authCookie"]);
 			$('#dst').html(msg_dst);
			//synapse_login();
			send(0,"core_Login", { 
				"username": "admin",
				"password": "bla"
			});				
 			
 		});

 		synapse_register("module_Error",function(msg_src, msg_dst, msg_event, msg)
 		{
 			$('#module_Error').html(msg["description"]);
 		});

 		
 		synapse_register("module_Login",function(msg_src, msg_dst, msg_event, msg)
 		{
 			$('#module_Login').html("Logged in as " + msg["username"]);

			getupdate();
			
 		});


		/// JAVA SCRIPT EVENT HANDLERS
		$(document).ready(function(){
			

		});


	</script>

<style>
.bar {
	width:50%;
	display: inline-block;
}
.value {
	width:30%;
	display: inline-block;
}

#sessions div 
{
	background-color: #eeffee;
	margin: 1px;
}

#queue .running 
{
	background-color: #eeffee;
	margin: 1px;
}

#queue .queued
{
	background-color: #ffeeee;
	margin: 1px;
}



</style>

</head>

<body 
	class='ui-widget'
	style='
			height:100%;
'>
	<div 
		class='ui-widget-content'
		style='
			position:absolute;
			left:0;
			top:0;
			width:50%; 
			height:50%;
			overflow:auto; 
	'>
		<div class='ui-widget-header'>Sessions:</div>
		<div id='sessions'></div>
	</div> 

	<div 
	class='ui-widget-content'
	style='
		position:absolute;
		left:50%;
		top:0;
		width:50%; 
		height:50%;
		overflow:auto;
	'>
		<div class='ui-widget-header'>HTTP server status:</div>
		<pre>
		<div id='http_json_Status'	></div>
		</pre>
	</div> 

	<div 
	class='ui-widget-content'
	id='broadcastLog'
	style='
		position:absolute;
		left:0%;
		top:50%;
		width:50%; 
		height:50%;
		overflow:auto;
	'>
		<div class='ui-widget-header'>Call queue:</div>
		<div id='queue'></div>
	</div> 

	<div 
	class='ui-widget-content'
	style='
		position:absolute;
		left:50%;
		top:50%;
		width:50%; 
		height:50%;
		overflow:auto;
	'>
		<div class='ui-widget-header'>Statistics:</div>

		<div class='value' id='sendsValue'></div><div class='bar' id='sendsBar'></div>

		<div class='value' id='callsValue'></div><div class='bar' id='callsBar'></div>

		<div class='value' id='queueValue'></div><div class='bar' id='queueBar'></div>

		<div class='value' id='threadValue'></div><div class='bar' id='threadBar'	></div>

		<div class='value' id='sessionValue'></div><div class='bar' id='sessionBar'	></div>
	</div> 

</body>
</html>