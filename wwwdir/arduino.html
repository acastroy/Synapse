<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Home controller</title>

    <link href="/css/ui-darkness/jquery-ui.css" rel="stylesheet" type="text/css"/>
  
    <script type="text/javascript" src="/synapse/synapse.js"></script>
    <script type="text/javascript" src="arduino.js"></script>

	<style>
        .prototype
        {
            display: none;
        }
 	</style>

    <script>
        $(document).ready(function(){

            //////////////////////// node.ping
            var pings={};
            $('.prototype[event="node.ping"]')
                .on("widget_update",function(e, msg)
                {
                    clearTimeout(pings[msg["node"]]);
                    $(this).text("node "+msg["node"]);
                    var last_ping=serverTime()-msg["time"];
                    if (last_ping>65)
                    {
                        $(this).css('background-image', 'url("arduino/offline.png")');
                    }
                    else
                    {
                        $(this).css('background-image', 'url("arduino/online.png")');
                        //show offline when we dont receive the next ping in time
                        setTimeout(function()
                        {
                            $(this).css('background-image', 'url("arduino/offline.png")');

                        }, 65000-last_ping*1000);
                    }
                });

            //////////////////////// rfid.state
            $('.prototype[event="rfid.state"]')
                .on("widget_created",function(e, msg)
                {
                    $(this).attr("title","Node "+msg["node"]);
                    $('.lock',this).button().click(function()
                        {
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "rfid.lock",
                                "data": 0
                            });
                        });
                    $('.unlock',this).button().click(function()
                        {
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "rfid.unlock",
                                "data": 10
                            });
                        });
                })
                .on("widget_update",function(e,msg)
                {
                    if (msg["data"].substr(0,4)=="lock")
                    {
                        $(".lock",this).css("background","red");
                        $(".unlock",this).css("background","gray");
                    }
                    else
                    {
                        $(".lock",this).css("background","gray");
                        $(".unlock",this).css("background","green");
                    }

                });
        });


    </script>
</head>


<body 
    class="ui-widget ui-widget-content" 
    style="
        font-size: 14px;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000000"
>

<div class='prototype' event='node.ping' style='
    padding-left: 1em;
    background-repeat: no-repeat;
'>
</div>

<div class='prototype' event='rfid.state' style=''>
    <input class='lock' type="submit" value="Lock">
    <input class='unlock' type="submit" value="Unlock">
</div>



</body>
</html>

