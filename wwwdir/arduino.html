<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Home controller</title>

    <link href="/css/ui-darkness/jquery-ui.css" rel="stylesheet" type="text/css"/>
    
    <script type="text/javascript" src="/synapse/synapse.js"></script>

    <script type="text/javascript" src="arduino.js"></script>

    <script src="lib/jquery.ui.colorPicker.js" type="text/javascript"></script>
    <link rel="stylesheet" href="lib/jquery.ui.colorPicker.css">

	<style>
        .prototype
        {
            display: none;
        }
 	</style>

    <script>
        $(document).ready(function(){

            //////////////////////// node.ping
            var pings={};
            $('.prototype[event="node.ping"]')
                .on("widget_created",function(e, msg)
                {
                    var dialog=$('.dialog',this);
                    var name=$('.name',this).text("node "+msg["node"]);

                    //menu to send events with data (will show send-dialog)
                    var menu=$('.menu',this).menu({
                        "select":function(e,ui)
                        {
                            $('.node', dialog).text(msg["node"]);
                            $('.event', dialog).text(ui.item.attr("send"));
                            dialog.show().dialog();

                            $('.send', dialog).off().click(function()
                            {
                                send(0,"arduino_Send", {
                                    "node": msg["node"],
                                    "event": ui.item.attr("send"),
                                    "data": $('.data', dialog).val()
                                });
                            });
                        }
                    });


                    //show menu
                    name.click(function()
                    {
                        menu.show().position({
                            my: "left top",
                            at: "left bottom",
                            of: name
                        });

                        $(document).one("click",function()
                        {
                            menu.hide();
                        });
                        return(false);
                    });


                })
                .on("widget_update",function(e, msg)
                {
                    clearTimeout(pings[msg["node"]]);
                    var last_ping=serverTime()-msg["time"];
                    if (last_ping>65)
                    {
                        $(this).css('background-image', 'url("arduino/offline.png")');
                    }
                    else
                    {
                        $(this).css('background-image', 'url("arduino/online.png")');
                        //show offline when we dont receive the next ping in time
                        setTimeout(function()
                        {
                            $(this).css('background-image', 'url("arduino/offline.png")');

                        }, 65000-last_ping*1000);
                    }
                });

            //////////////////////// rfid.state
            $('.prototype[event="rfid.state"]')
                .on("widget_created",function(e, msg)
                {
                    $(this).attr("title","Node "+msg["node"]);
                    $('.lock',this).button().click(function()
                        {
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "rfid.lock",
                                "data": 0
                            });
                        });
                    $('.unlock',this).button().click(function()
                        {
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "rfid.unlock",
                                "data": 10
                            });
                        });

                })
                .on("widget_update",function(e,msg)
                {
                    if (msg["data"].substr(0,4)=="lock")
                    {
                        $(".lock",this).css("background","red");
                        $(".unlock",this).css("background","gray");
                    }
                    else
                    {
                        $(".lock",this).css("background","gray");
                        $(".unlock",this).css("background","green");
                    }

                });

            //////////////////////// led strip
            synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
            {
                send(0, "arduino_DbGet", { 
                    table: "led"
                });
            });

            synapse_register("arduino_DbItems",function(msg_src, msg_dst, msg_event, msg)
            {
                if (msg["table"]!="led")
                    return;

                //delete all presets
                $('.led-controller .preset').remove();

                //create all presets
                for (i in msg["items"])
                {
                    $('.led-controller .presets').append("<a href='#' class='preset' preset='"+msg["items"][i]+"'>"+msg["items"][i]+"</a> ");
                }
            });

            $('.prototype[event="led.boot"]')
                .on("widget_created",function(e, msg)
                {
                    $(this).attr("title","Led strip node "+msg["node"]);
                    $(".col", this).colorPicker({
                        size: 200,
                        format: 'rgb',
                        colorChange:function(e, ui)
                        {
                            var colnr=parseInt($(this).attr('colnr'));
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "led.col",
                                "data": $(this).attr('colnr')+" "+ (ui.red>>1) +" "+ (ui.green>>1) +" "+ (ui.blue>>1)
                            });
                        }

                    });

                    $( ".fade",this ).slider({
                        //orientation: "vertical",
                        range: "min",
                        min: -30,
                        max: 30,
                        value: 0,
                        slide: function( event, ui ) {
                            var colnr=parseInt($(this).attr('colnr'));
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "led.fade",
                                "data": $(this).attr('colnr')+" "+ (-ui.value)
                            });
                            
                      }
                    });

                    $( ".speed",this ).slider({
                        //orientation: "vertical",
                        range: "min",
                        min: 0,
                        max: 255,
                        value: 127,
                        slide: function( event, ui ) {
                            var colnr=parseInt($(this).attr('colnr'));
                            send(0,"arduino_Send", {
                                "node": msg["node"],
                                "event": "led.speed",
                                "data": ui.value
                            });
                            
                      }
                    });

                    $(".presets", this).on("click", ".preset", function()
                    {
                        console.log(this);
                        console.log(widget_class);
                    });

                    $(".preset-save").click(function()
                    {
                        send(0, "arduino_DbPut", { 
                            table: "led",
                            name: $()
                        });

                    });
                })
                .on("widget_update",function(e,msg)
                {
                    ;;
                });


        });


    </script>
</head>


<body 
    class="ui-widget ui-widget-content" 
    style="
        font-size: 14px;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000000"
>

<div class='prototype' event='node.ping' style='
    padding-left: 1em;
    background-repeat: no-repeat;
'>
    <span class='name'></span>
    <ul class='menu' style='display:none; position:absolute; z-index:10'>
      <li send='lock.set_pwm'><a href='#'>Set PWM</a></li>
      <li send='rfid.set_adm'><a href='#'>Set admin key</a></li>
      <li send='rfid.set_ut'><a href='#'>Set unlock time</a></li>
    </ul>
    <div class='dialog' style='display:none' title='Send event'>
        To node: <span class='node'></span><br>
        Event: <span class='event'></span><br>
        Data: <input class='data' type='text'></input><br>

        <button class='send'>Send</button>
    </div>

</div>

<div class='prototype' event='rfid.state' style=''>
    <button class='lock'>Lock</button>
    <button class='unlock'>Unlock</button>
</div>

<div class='prototype led-controller' event='led.boot' style='border: solid'>
    <div>
        <input class='preset-name' type='text'>
        <button class='preset-save'>Save</button>
        <button class='preset-delete'>Delete</button>
        <div class="presets">
        </div>
    </div>

    <div style='display:inline-block; padding:1em;'>
        <div style='width:20em' class='speed' title='Effect speed'></div>
        <div >
            Main color
            <input type="text" class='col' colnr='0'>
        </div>
        <div style='width:20em' class='fade' colnr='0' title='Fade speed'></div>
    </div>

    <div style='display:inline-block;padding:1em;'>
        <div>
            Secondairy color
            <input type="text" class='col' colnr='1'>
        </div>
        <div style='width:20em' class='fade' colnr='1' title='Fade speed'></div>
    </div>

    <div style='display:inline-block;padding:1em;'>
        <div>
            Background color
            <input type="text" class='col' colnr='2'>
        </div>
        <div style='width:20em' class='fade' colnr='2' title='Fade speed'></div>
    </div>
</div>


</body>
</html>

