<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- (C)edwin@datux.nl - released under GPL -->
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>internetpapier.nl - BETA</title>

	<script src="svg.js"></script>
	<script type="text/javascript" src="synapse.js"></script>
	<script type="text/javascript" src="jquery.url.js"></script>
	<script type="text/javascript">

		function Cpoint(x,y)
		{
			this.x=x;
			this.y=y;
	
			this.copy=function(point)
			{
				this.x=point.x;
				this.y=point.y;
			}
			
		}
	
		var mouseInterval=50; //max update inteval in mS (can be higer if mouseMax is exceeded)
		var mouseMax=25; //max mouse pixel offset before sending (regardless of update interval)
	
		var mousePoint=new Cpoint(); //current mouse position
	
		//mouse info sending to server:
		var mouseSendPoint=new Cpoint(); //last mousepoint sent to server
		var mouseSendTime=0; //last time the mousePosition was anaylsed by updateGameField
	
		var mouseMode="";		
		var mouseTarget="";

		//temporary local objects counter
		var tempCount=0;
		
		var currentObjectId=0;
		var paperModId=0;
	
		var drawMode="l";
			
		//incremental draw stuff
		var clientId=0;
		var clients=new Array(); 
		var ourId=0;

		var canvasWidth=0;
		var canvasHeight=0;
		var drawing;
		var drawingHtml;
		
		var autoCommit=false;

		
		//filter dangerous stuff from user input.
		//NOTE: do this when you receive the data back from the server, not when sending to it!
		function filterInput(s)
		{
			return(s.replace(/</g,"&lt;").replace(/>/g,"&gt;"));
		}

		//calculate browser coordinates to server coordinates
		function toServer(x,y)
		{
			
			//return ( { "x":x, "y":y } );
			return ({
				"x":Math.round((x * 10000) / $("#drawing").width()),
				"y":Math.round((y * 10000) / $("#drawing").height())
			});
		}
	
		//calculate server coordinates to browser coordinates 
		//OBSOLETE: we use a svg viewbox
		function toBrowser(x,y)
		{
			return ( { "x":x, "y":y } );
			return ({
				"x":((x*canvasWidth)/10000),
				"y":((y*canvasHeight)/10000)
			});
		}				

		//calculate server line width to browser linewidth
		function widthToBrowser(width)
		{
			//for now we use the average of canvas width and height
			return (
					(((width*canvasWidth)/1000)+((width*canvasWidth)/1000))/2
			);
		}

		
		function paperLink(id,text)
		{
			return ("<a class='paperLink' href='paper.html?id="+id+"'>"+text+"</a>");
		}

		function addChat(html)
		{
			$('#chatList').append(html);

			//scroll to end
			var objDiv = document.getElementById("chatList");
			objDiv.scrollTop = objDiv.scrollHeight;
		}


		
		//information about the object a client is currently drawing
		function Cclient(id)
		{
			
		}

		



		/*** Drawing protocol
		
		Drawing stuff is done with paper_clientDraw.
		The message is translated to a paper_serverDraw and forwarded to all clients.
		The message is normally not echoed back, unless requested
		
		CAN BE SET BY CLIENT:
		cmd:		command to do:
						update: create/modify element 
						delete: remove element
						refresh: 	let the server resend an update cmd with all info about the element, to this client. 
									this is used to prevent inconsitencys due to local caching.
						ready: when doing a full redraw on join, this indicates the drawing is "ready"					

						
		Only for updates with new (not yet existing) objects:
		element:		svg element type (e.g. circle,rect,polyline)
		
		update parameters:
		add:    	svg attributes to append data to (used for polylines)
		set:		svg attributes to set/replace


		update/delete parameters:		
		id:			element id for update/delete. 
					if set to 'new' with an update, the server will create a new element and replace it with its id.
					if not set by with an update/refresh, the id is replaced by id used in the last 'update' for this client. 
		beforeId:   set by server to the id of the element this element should be inserted before. this is important to keep the order of all the elements correct.
					normally only set when requesting a refresh.
		
		ONLY SET BY SERVER:
		src:		added by server. session id that send the message
		
		
		'
		 */


		function draw(msg)
		{
//			drawing=document.getElementsByTagNameNS(svgns, 'svg')[0];
			var suspendID = drawing.suspendRedraw(250);
			 
			//create/update object
			if (msg["cmd"]=="update")
			{
				if (msg["id"]!=null)
				{
					var element=document.getElementById(msg["id"]);
					//element not found? 
					if (element==null)
					{
						//create new element
						var element = document.createElementNS(svgns, msg["element"]);
						element.setAttribute('id', msg["id"]);
	
						//insert before existing or just append?
						var beforeElement=null;
						if (msg["beforeId"]!=null)
							beforeElement=document.getElementById(msg["beforeId"]);
	
						//NOTE: svgweb is buggy and doesnt support insertbefore with a null element, so work around:
						if (beforeElement==null)
						{
							drawing.appendChild(element);
	//						svgweb.appendChild(element,drawing);
	//						svgweb.appendChild(drawing,element);
						}
						else
							drawing.insertBefore(element, beforeElement);							
					}
					
					//we need to add/set attributes?
					if (msg["add"] || msg["set"])
					{
						for (var attrName in msg["set"])
						{
							element.setAttribute(attrName, msg["set"][attrName]);
						}							
	
						for (var attrName in msg["add"])
						{
							if (element.getAttribute(attrName)!=null)
							{
								element.setAttribute(attrName, element.getAttribute(attrName)+msg["add"][attrName]);
	//							var s=msg["add"][attrName].substr(1).split(",");
	//							element.points.appendItem({x:s[0],y:s[1] });
	
							}
							else
								element.setAttribute(attrName, msg["add"][attrName]);
						}
					}
				}
				
				//remove any temporary objects
				if (msg["tempId"]!=null)
				{
					var element=document.getElementById(msg["tempId"]);
					if (element!=null)
					{
						drawing.removeChild(element);
					}
				}		

			}
			//delete object
			else if (msg["cmd"]=="delete")
			{
				console.log("DEL"+msg["id"]);
				var element=document.getElementById(msg["id"]);
				if (element!=null)
				{
					drawing.removeChild(element);
				}	
			}
			else if (msg["cmd"]=="ready")
			{
				//NOTE: this also works around a weird chromuim refresh bug.
				$("#loading").hide();
			}			

			//update cursor?
			if (msg.cursor!=null)
			{
				var cursor=document.getElementById('cursor'+msg["src"]);
				if (cursor==null)
				{
					//create a group for this client's cursor
					cursor = document.createElementNS(svgns, 'g');
					cursor.setAttribute('id', 'cursor'+msg["src"]);
					cursor.setAttribute('stroke', '#000000');
					cursor.setAttribute('stroke-width', '10');
					drawing.appendChild(cursor);

					//add drawing to the cursor group
					var e = document.createElementNS(svgns, 'line');
					e.setAttribute('x1', '-200');
					e.setAttribute('x2', '+200');
					e.setAttribute('y1', '0');
					e.setAttribute('y2', '0');
					cursor.appendChild(e);					

					var e = document.createElementNS(svgns, 'line');
					e.setAttribute('x1', '0');
					e.setAttribute('x2', '0');
					e.setAttribute('y1', '-200');
					e.setAttribute('y2', '+200');
					cursor.appendChild(e);					

					var e = document.createElementNS(svgns, 'text');
					e.setAttribute('x', '0');
					e.setAttribute('y', '300');
					e.setAttribute('font-size','200');
					e.setAttribute('stroke','#aaaaaa');
					
					cursor.appendChild(e);					

					var textNode = document.createTextNode('psy0rz', true);
					e.appendChild(textNode);
				}
				cursor.setAttribute('transform', 'translate('+msg.cursor.x+','+msg.cursor.y+')');
				
			}

			drawing.unsuspendRedraw(suspendID);
//			drawing.forceRedraw();
			//drawing.unsuspendRedrawAll();			
		}
		

		synapse_register("paper_ServerDraw",function(msg_src, msg_dst, msg_event, msg)
		{
			draw(msg);
		});

		//send drawing msg to server 
		//note: you need to specifiy server coordinates instead of browser coordinates here.		
		function sendDraw(msg)
		{
			//only if we're joined to something
			if (!currentObjectId)
				return;
			
			//send it to server
			send(paperModId,"paper_ClientDraw", msg);

			//the server doesnt echo our stuff back, so we can handle it locally without lag
			//call the draw function and emulate the server by adding some stuff
			msg["src"]=ourId;
			if (msg["id"]==null || msg["id"]=="new")
				msg["id"]="temp"+tempCount;
			draw(msg);
		}


		//user moves mouse		
		function mouseMove(force)
		{

			//mouse throttling function, to prevent too many updates per second
			//no change?
			if (force!=true && mousePoint.x==mouseSendPoint.x && mousePoint.y==mouseSendPoint.y)
				return;

			currentTime=new Date().getTime();

			//send updates at a max fps, or more when the mouse moves fast
			if (	force==true ||
					(currentTime-mouseSendTime>=mouseInterval) || 
					Math.abs(mousePoint.x-mouseSendPoint.x)> mouseMax ||
					Math.abs(mousePoint.y-mouseSendPoint.y)> mouseMax 
			)	
			{ 

				var c=toServer(mousePoint.x,mousePoint.y);
				var msg={};

				//cursor
				msg['cursor']=c;
				
				if (mouseMode=="line")
				{
					msg['cmd']='update';
					msg['add']={
						'points': ' '+c.x+','+c.y
					}
				}
				else if (mouseMode=="delete")
				{ 
					if (mouseTarget!="" && mouseTarget!="bg")
					{
						msg['cmd']='delete';
						msg['id']=mouseTarget;
					}				
				}

				sendDraw(msg);

				mouseSendPoint.x=mousePoint.x;
				mouseSendPoint.y=mousePoint.y;
				mouseSendTime=currentTime;
			}
		}	

		//user starts a mouse operation (clicks somewhere)
		function mouseStart(m)
		{
			tempCount++;
			mouseMode=$('#modes .selected').attr("value");
			
			if (mouseMode=="line")
			{
				sendDraw({
					'cmd'		:'update',
					'id'		:'new',
					'element'	:'polyline',
					'set'		: {
						'fill'			: 'none',
						'stroke'		: $('#colors .selected').attr("value"),
						'stroke-width'	: $('#widths .selected').attr("value")
					}
				});
			}

			//force a mouse move
			mouseMove(true);
		}

		//user ends operation (leaves or mouse up)
		function mouseEnd(m)
		{
			if (mouseMode!="")
			{
				mouseMode="";
				sendDraw({
					'cmd'		:'refresh',
					'tempId'	:'temp'+tempCount
				});				
			};
		}
	    
	    synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
			ourId=msg_dst;

			/// figure out client name
			var clientName=$.readCookie('clientName', { path:"/" } );
			if (!clientName)
			{
				//make up a "random" guest name
				clientName="User "+msg_dst;
			}
			
			//set the name input field
			$("#clientName").val(clientName);
			

			
			/// JAVA SCRIPT EVENT HANDLERS

			$("#clientName").keyup(function(m)
			{
				$.setCookie('clientName', $("#clientName").val(), { duration:365, path:"/" });
				sendDraw( [ "n" , $("#clientName").val() ] );
			});

			$("#chatInput").keydown(function(m)
			{
				if (m.keyCode==13)
				{
					sendDraw( [ "." , $("#chatInput").val() ] );
					sendDraw( [ "s" ] );
					$("#chatInput").val("");						
				}					
	 		});

			$("#chatInput").val("");
			
			//a tool is clicked
			$(".tool").click(function(m)
			{
				//unselect all tools in that group
				$(this).parent().children(".tool").removeClass('selected');
				//select this one
				$(this).addClass('selected');
				
//				var i=0;
//				var cmds=new Array();
//				while ($(this).attr("cmd"+i))
//				{
//					cmds.push($(this).attr("cmd"+i));
//					i++;
//				};
//				
//				sendDraw(cmds); 

				$("#chatInput").focus();
			});

			//clear button
			$("#clear").click(function(m)
			{
				//a clear actually creates a new drawing so the old one is preserved
				send(0,"paper_Create", { "moveClients":1 } );
			});



			//wait until svgloading is complete
		    window.addEventListener('SVGLoad', function() {
			    
				//create a svg node and assign it to global variable "drawing".
				drawing = document.createElementNS(svgns, "svg");

				//set some basic attributes
				drawing.setAttribute("version", "1.2");
				drawing.setAttribute("baseProfile", "tiny");
				drawing.setAttribute("viewBox", "0 0 10000 10000");
				drawing.setAttribute("id","bg");
				drawing.setAttribute("preserveAspectRatio", "none");

				//default settings
				drawing.setAttribute("stroke-linecap","round");
				drawing.setAttribute("stroke-linejoin","round");

//				drawing.setAttribute("color-rendering","optimizeSpeed");
//				drawing.setAttribute("shape-rendering","optimizeSpeed");
//				drawing.setAttribute("text-rendering","optimizeSpeed");
//				drawing.setAttribute("image-rendering","optimizeSpeed");
				

				//wait until rootobject is created
				drawing.addEventListener('SVGLoad', function(evt) 
				{
					//when its in flashmode, the references change somehow, so re-get it:				
					drawing=document.getElementsByTagNameNS(svgns, 'svg')[0];
					
					//set mouse move event
					//NOTE: pageX is not set when using chromium in flash mode? when we use jquery mousemove its ok ,but then we cant see 
					//which object is hovered over.
					drawing.addEventListener('mousemove', function(m) 
					{
						mouseTarget=m.target.id;
						//work around SVG bug http://code.google.com/p/svgweb/issues/detail?id=244
						if(drawing.fake)
						{
							//flash workaround
							mousePoint.x=m.clientX;
							mousePoint.y=m.clientY;
						} 
						else 
						{
							//normal
							mousePoint.x=m.clientX-$("#drawing").offset().left;
							mousePoint.y=m.clientY-$("#drawing").offset().top+document.body.scrollTop ;
						}
													
						mouseMove(false);
					});

					//set mouse click event
					drawing.addEventListener('mousedown', function(m)
					{
						if (m.preventDefault)
							m.preventDefault();
						else
							m.returnValue=false;


						mouseStart(m);

						return false;
					});

					//set mouse up event
					drawing.addEventListener('mouseup', mouseEnd)
							
					//set mouse leave event
					//(doesnt work with addeventlistener!)
					$("#drawing").mouseleave(mouseEnd);
						
					/// start mouse update engine
					window.setInterval(mouseMove, mouseInterval);


					//join the specified paper
					send(0,"paper_Join", {
						"objectId":jQuery.url.param("id")
					});
							

				});
				
						
				
				//add drawing rootobject to html container
				drawingHtml = document.getElementById("drawing");
				svgweb.appendChild(drawing, drawingHtml);
		     }, false);

		
 		});

		function reset()
		{
			$('#clientList').empty();
			$('#chatList').empty();
			autoCommit=true; 
			//drawing.
			$(".tool").removeClass('selected');
			$(".defaultTool").addClass('selected');

		}

	    
		//we've joined a object
 		synapse_register("object_Joined",function(msg_src, msg_dst, msg_event, msg)
		{
			//doesnt the url match?
			if (jQuery.url.param("id")!=msg["objectId"])
				document.location="paper.html?id="+msg["objectId"];
 			
			//we've joined a object, from now on draw on it.
			currentObjectId=msg["objectId"];
			paperModId=msg_src;
			$("#objectId").html(msg["objectId"]);
			reset();
		});
 		
 				

 		

	




	</script>

	<style>
		body 
		{
			margin:0;
			padding:0;
			height:100%;
		} 

		.client
		{
			margin-top:2px;
			padding:5px;
			border-bottom-style:dashed;
			border-bottom-color:#aaaaaa;
		}

		#objectManager
		{
			position:absolute; 
			left:0;
			top: 0;
			width: 16em;
			bottom:0;
			border-style:none;
		}

		#drawing
		{
			position:absolute; 
			left:16em;
			top: 0;
			right: 0;
			bottom:0;
			cursor:crosshair;
			margin: 0;
			padding: 0;
		}

		
		
		
		#loading
		{
			position:absolute;
			left:0;
			right:0;
			top:0;
			bottom:0;
			background-fill:none;
			text-align:center;
			color: red;
			font-size: 1000%;
		}
		
		#colors
		{
			
		}
		
		.tool
		{
			width:2em;
			max-width:2em;
			height:2em;
			max-height:2em;
			border-width:2px;
			border-style:solid;
			cursor:pointer;
			display:inline-block;
			border-color:#ffffff;
		}
		
		.selected
		{
			border-color:#aaaaaa;
		}
		
		img
		{
			border:0;
			margin:0;
			padding:0;
			display:inline;
		}
		
		#chatList
		{
			max-height:8em;
			overflow-y:scroll;
		}
		
		#clientList
		{
			max-height:8em;
			overflow-y:auto;		
		}
		
		.paperLink
		{
			background-color: yellow;
			text-decoration: none;
			display:block;
		}
	</style>

</head>


<body class='ui-widget'>
	<div class='ui-widget-content' id='objectManager'>

		<div class='ui-widget-header'>Papier:</div>

		Papier nummer: <span id='objectId'></span>
		<br>
		
		<br>

		<input type='submit' value='Nieuw' id='clear'>

		<div class='ui-widget-header'>Gereedschap:</div>

		Naam: <input id='clientName' type='text' value='' size=10>

		<div id='colors'>
			<div class='tool color defaultTool' style='background-color:#000000' value='#000000'>&nbsp;</div>
			<div class='tool color ' style='background-color:#0000ff' value='#0000ff'>&nbsp;</div>
			<div class='tool color ' style='background-color:#00ff00' value='#00ff00'>&nbsp;</div>
			<div class='tool color ' style='background-color:#00ffff' value='#00ffff'>&nbsp;</div>
			<div class='tool color ' style='background-color:#FF8040' value='#FF8040'>&nbsp;</div>
			<div class='tool color ' style='background-color:#ffffff' value='#ffffff'>gum</div>
			<br>
			<div class='tool color' style='background-color:#ff0000' value='#ff0000'>&nbsp;</div>
			<div class='tool color' style='background-color:#ff00ff' value='#ff00ff'>&nbsp;</div>
			<div class='tool color' style='background-color:#ffff00' value='#ffff00'>&nbsp;</div>
			<div class='tool color' style='background-color:#999999' value='#999999'>&nbsp;</div>
			<div class='tool color' style='background-color:#804000' value='#804000'>&nbsp;</div>
			<div class='tool color' style='background-color:#F87217' value='#F87217'>&nbsp;</div>
			<br>
		</div>		

		<div id='widths'>
			<div class='tool width' value='10'><img src='img/pen1.png' style='width:1em' ></div>
			<div class='tool width' value='20'><img src='img/pen1.png' style='width:1.2em'></div>
			<div class='tool width' value='30'><img src='img/pen1.png' style='width:1.3em'></div>
			<div class='tool width defaultTool' value='40'><img src='img/pen1.png' style='width:1.4em' ></div>
			<br>
			<div class='tool width' value='100'><img src='img/pen2.png' style='width:1em' ></div>
			<div class='tool width' value='200'><img src='img/pen2.png' style='width:1.2em' ></div>
			<div class='tool width' value='300'><img src='img/pen2.png' style='width:1.3em' ></div>
			<div class='tool width' value='400'><img src='img/pen2.png' style='width:1.4em' ></div>		
		</div>

		<div id='modes'>
			<div class='tool mode defaultTool' value='line'>line</div>
			<div class='tool mode' value='delete'>delete</div>
			<div class='tool mode' value='move'>move</div>
		</div>


		<div class='ui-widget-header'>Chat:</div>
		<div id='chatList'></div>
		<input id='chatInput' type='text' value='' >


		<div class='ui-widget-header'>Andere mensen:</div>
		<div id='clientList'></div>


	</div>


	<div id='loading' >Loading...</div>


	<div id='drawing'></div>		


	
</body>
</html>