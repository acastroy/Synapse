<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Synapse asterisk test</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="jquery-ui.js"></script>
	<link href="css/redmond/jquery-ui.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="json2.js"></script>
	<script type="text/javascript" src="synapse.js"></script>
	<script type="text/javascript" src="synapse-ui.js"></script>
	<script type="text/javascript" src="jquery.svg.js"></script>
	<script type="text/javascript" src="jquery.drawinglibrary.js"></script>
	<script type="text/javascript">


		/// SYNAPSE EVENT HANDLERS
		synapse_register("error",function(errortxt)
		{
			$('#error').html(errortxt);
		});	
				
 		synapse_register("module_Error",function(msg_src, msg_dst, msg_event, msg)
 		{
 			$('#error').html(msg["description"]);
 		});


 		synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
//			synapse_login();
			//request a refresh, to learn about all objects
			send(0,"asterisk_refresh", { 
			});

		});

 		synapse_register("asterisk_reset",function(msg_src, msg_dst, msg_event, msg)
 		{
			//reset all known state info
			//(new info probably follows because we send a asterisk_refresh request)
			$('#deviceList').empty();

		});

		function escapeId(myid) { 
			//escape stuff to make it jquery compatible. asterisk channel ids look like this:
			// Local/10@from-inside-TR_Dozy-6829,2
			return '#' + myid.replace(/([,@\/.])/g,'\\$1');
		}

 		synapse_register("asterisk_updateDevice",function(msg_src, msg_dst, msg_event, msg)
 		{

			//device doesnt exist yet?
			if ($(escapeId(msg["id"])).length==0)
			{
				//add dom objects
				html="<div class='device' id='"+msg["id"]+"'>";
				html+="<div class='channelList'></div>";
				html+="<div class='deviceInfo'>"+msg["id"]+"</div>";
				html+="</div>";
				$('#deviceList').append(html);
			}

			html=msg["callerId"];
			if (!msg["online"])
			{
				html+="<br><b>OFFLINE</b>";
			}
			//set html of device deviceInfo dom object:
			$(escapeId(msg["id"])+" .deviceInfo").html(html);
		});


 		synapse_register("asterisk_delDevice",function(msg_src, msg_dst, msg_event, msg)
 		{
			$(escapeId(msg["id"])).remove();
		});




 		synapse_register("asterisk_debugChannel",function(msg_src, msg_dst, msg_event, msg)
		{
			$(escapeId(msg["id"])+" .channelDebug").append(
				"<br><b>"+msg["Event"]+"</b><br>"
			);
			for (var msgI in msg)
			{
				if (msgI!="id" && msgI!="serverId" && msgI!="Event")
				{
					$(escapeId(msg["id"])+" .channelDebug").append(
						msgI+":"+msg[msgI]+"<br>"
					);
				}
			}
			

		});


		function prettyCallerId( callerId, callerIdName)
		{
			var txt="";
			if (callerId!="")
				txt=txt+callerId;
			else
				txt="(unknown number)";

			if (callerIdName!="")
				txt=txt+" '"+callerIdName+"'";

			return txt;					
		}

 		synapse_register("asterisk_updateChannel",function(msg_src, msg_dst, msg_event, msg)
 		{
			var oldDebug="";

			//does the channel exist?
			if ($(escapeId(msg["id"])).length!=0)
			{
				//doesnt it exist under the specified device?
				if ($(escapeId(msg["deviceId"]) + " " + escapeId(msg["id"])).length==0)
				{
					//then it probably has been moved/renamed, so delete the channel and recreate it below.
					oldDebug=$(escapeId(msg["id"])+" .channelDebug").html();
					$(escapeId(msg["id"])).remove();			
				}
			}


			//channel doesnt exist?
			if ($(escapeId(msg["id"])).length==0)
			{
				//add dom objects
				html="<div class='channel' id='";
				html+=msg["id"];
				html+="'>";
				html+="<div class='channelInfo'></div>";
				html+="<div class='channelDebug'>"+oldDebug+"</div>";
				html+="</div>";
				//add the channel to the corresponding device:
				$(escapeId(msg["deviceId"])+' .channelList').append(html);

				//on hover show the info
				$(escapeId(msg["id"])).hover(
						//show ...
						function ()	
						{ 
							 $(this).children(".channelInfo").show(); 
						},
						//hide ...
						function () {
							 $(this).children(".channelInfo").hide(); 
						}
				);
			}

			//set channel status
			if  ( msg["state"] == "Up" )
			{
				$(escapeId(msg["id"])).css("background", "green");
			}
			else if ( msg["state"] == "Ringing" )
			{
				$(escapeId(msg["id"])).css("background", "red");
			}
			else
			{
				$(escapeId(msg["id"])).css("background", "black");
			}


			//set html of channelInfo dom object:
			if (msg["incoming"]==1)
			{
				$(escapeId(msg["id"])+" .channelInfo").text(
					msg["state"] + ": "+ 
					"Incoming call from " + prettyCallerId(msg["linkCallerId"],msg["linkCallerIdName"]) + 
					" for " + prettyCallerId(msg["callerId"], msg["callerIdName"])
				)
			}
			else
			{
				$(escapeId(msg["id"])+" .channelInfo").text(
					msg["state"] + ": "+ 
					"Outgoing call to " + prettyCallerId(msg["linkCallerId"],msg["linkCallerIdName"]) + 
					" from " + prettyCallerId(msg["callerId"], msg["callerIdName"])
				)
			}

// 			//linked to something we know, so we can draw a line?
// 			if (msg["linkId"] != "" && $(escapeId(msg["linkId"])).length!=0)
// 			{
// 				$(escapeId(msg["id"])+" .channelLink").drawLine(
// 					$(escapeId(msg["id"])).offset().left,
// 					$(escapeId(msg["id"])).offset().top,
// 					$(escapeId(msg["linkId"])).offset().left,
// 					$(escapeId(msg["linkId"])).offset().top
// 				);
// 			}

		});


 		synapse_register("asterisk_delChannel",function(msg_src, msg_dst, msg_event, msg)
 		{
			$(escapeId(msg["id"])).remove();
		});

 		synapse_register("module_SessionEnded",function(msg_src, msg_dst, msg_event, msg)
 		{
		});


		/// JAVA SCRIPT EVENT HANDLERS
		$(document).ready(function(){

			$("#deviceList").sortable();
			$("#deviceList").disableSelection();

		});


	</script>

	<style>
		body 
		{
			margin:0;
			padding:0;
			height:100%;
			width: 100%;
		} 
	
		#deviceList
		{
			position:absolute; 
			left:0;
			bottom: 0;
			border-style:solid;
			height:100%;
			width: 100%;
			overflow: scroll;
		}

		.device
		{
			background-color: #eeeeee;
			float: left;
			border-style:solid;
			width: 20em;
			min-height: 5em;
			margin: 5px;
			padding: 5px;
		}

		.channelList
		{
			border-style:solid;
			border-color: #aaaaaa;
			border-width: 1px;
			width:100%;
			min-height: 2em;
			float: left;
		}

		.channel
		{
			border-style:solid;
			border-color:#eeeeee;
			float:left;
			min-width:1.9em;
			min-height:1.9em;
			margin:0;
			position: relative;
		}
		.channel:hover
		{
			border-color:yellow;
			
		}

		.channelInfo
		{
			border-style:solid;
			border-color:yellow;
			background-color: #ffffff;
			display: none;
			min-width:20em;
			min-height:10em;
			position: absolute;
			top: 1.9em;
			left: 1.9em;
			z-index: 1;
		}

		.channelDebug
		{
			background-color: #ffffff;
			color: #000000;	
			top: 1.9em;
			left: 1.9em;
			position: absolute;
			border-style: solid;
		}

	</style>

</head>


<body>


	<div id='deviceList'>
	</div>



	
</body>
</html>