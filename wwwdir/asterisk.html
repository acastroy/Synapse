<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Synapse asterisk test</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="jquery-ui.js"></script>
	<link href="css/redmond/jquery-ui.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="json2.js"></script>
	<script type="text/javascript" src="synapse.js"></script>
	<script type="text/javascript" src="synapse-ui.js"></script>
	<script type="text/javascript" src="jquery.cooquery.js"></script>
	<script type="text/javascript">

		loginDeviceId="";

		/// SYNAPSE EVENT HANDLERS
		synapse_register("error",function(errortxt)
		{
			$('#statusMsg').html("<span class='error'>"+errortxt+"</span>");
		});	
				
 		synapse_register("module_Error",function(msg_src, msg_dst, msg_event, msg)
 		{
 			$('#statusMsg').html("<span class='error'>"+msg["description"]+"</span>");
 		});


 		synapse_register("module_SessionStart",function(msg_src, msg_dst, msg_event, msg)
 		{
			$('#statusMsg').html("Requesting login...");
			send(0,"asterisk_authReq", { 
				authCookie: $.readCookie('asterisk_authCookie'),
				deviceId:   $.readCookie('asterisk_deviceId')
			});

			//request a refresh, to learn about all objects
			send(0,"asterisk_refresh", { 
			});
		});

 		synapse_register("asterisk_authCall",function(msg_src, msg_dst, msg_event, msg)
		{
			$('#statusMsg').html("Login by calling this number: <b>"+msg["number"]+"</b>");
		});

 		synapse_register("asterisk_authOk",function(msg_src, msg_dst, msg_event, msg)
		{
			$('#statusMsg').html("Logged in from "+msg["deviceId"]+" cookie="+msg["authCookie"]);
			loginDeviceId=msg["deviceId"];

			//store the device and authcookie in a browser cookie, so the user doesnt have to relogin everytime.
			$.setCookie('asterisk_authCookie',msg["authCookie"], {});
			$.setCookie('asterisk_deviceId',msg["deviceId"], {});

			//request a refresh, to learn about all objects
			send(0,"asterisk_refresh", { 
			});
		});

 		synapse_register("asterisk_reset",function(msg_src, msg_dst, msg_event, msg)
 		{
			//reset all known state info
			//(new info probably follows because we send a asterisk_refresh request)
			$('#deviceList').empty();

		});

		function escapeId(myid) { 
			//escape stuff to make it jquery compatible. asterisk channel ids look like this:
			// Local/10@from-inside-TR_Dozy-6829,2
			if (typeof myid != 'undefined')
				return '#' + myid.replace(/([,@\/.])/g,'\\$1');
			else
				return '#undefined';
		}

 		synapse_register("asterisk_updateDevice",function(msg_src, msg_dst, msg_event, msg)
 		{

			//device doesnt exist yet?
			if ($(escapeId(msg["id"])).length==0)
			{
				//add dom objects
				html="<div class='device' id='"+msg["id"]+"'>";
				html+="<div class='deviceInfo'></div>";
				html+="<div class='channelList'></div>";
				html+="</div>";
				$('#deviceList').append(html);
			}


			//update the device caller id:
			$(escapeId(msg["id"])+" .deviceInfo").html(msg["callerId"]);

			if (msg["online"])
				$(escapeId(msg["id"])).attr('state','');
			else
				$(escapeId(msg["id"])).attr('state','offline');


			//is it the device of the logged in user?
			if (msg["id"]==loginDeviceId)
			{
				$('#statusLoginUser').text(msg["callerId"]);				
			}
		});


 		synapse_register("asterisk_delDevice",function(msg_src, msg_dst, msg_event, msg)
 		{
			$(escapeId(msg["id"])).remove();
		});


		//creates, reuses or returns an existing channel object, using info from msg
		function getChannel(msg)
		{
			var oldDebug="";

			//does the channel exist already?
			if ($(escapeId(msg["id"])).length!=0)
			{
				//doesnt it exist under the specified device?
				if ($(escapeId(msg["deviceId"]) + " " + escapeId(msg["id"])).length==0)
				{
					//then it probably has been moved/renamed, so delete the channel and recreate it below.
					oldDebug=$(escapeId(msg["id"])+" .channelDebug").html();
					oldDebug+="<br>(moved/renamed)<br>";
					$(escapeId(msg["id"])).remove();
				}
			}

			//channel doesnt exist?
			if ($(escapeId(msg["id"])).length==0)
			{
				var newChannelHtml="";
				newChannelHtml+="<div class='channel' id='"+msg["id"]+"'>";
				newChannelHtml+="<div class='channelInfo'></div>";
				newChannelHtml+="<div class='channelDebug'>"+oldDebug+"</div>";
				newChannelHtml+="</div>";

				//check if there is a old channel that has deleted state
				var oldChannel=$(escapeId(msg["deviceId"]) +" .channelList [state=deleted]:first");
				if (oldChannel.length!=0 )
				{
					//replace a deleted channel:
					oldChannel.replaceWith(newChannelHtml);
				}
				else
				{
					//add a brand new channel object
					$(escapeId(msg["deviceId"])+' .channelList').append(newChannelHtml);
				}
				

				//on hover show the info
// 				$(escapeId(msg["id"])).hover(
// 					//show ...
// 					function ()	
// 					{ 
// 							$(this).children(".channelInfo").show(); 
// 					},
// 					//hide ...
// 					function () {
// 							$(this).children(".channelInfo").hide(); 
// 					}
// 				);

				//on click toggle debug info
				$(escapeId(msg["id"])).click(
					function ()	
					{ 
						$(this).children(".channelDebug").toggle(); 
					}
				);

			}
			return ($(escapeId(msg["id"])));
		}


 		synapse_register("asterisk_debugChannel",function(msg_src, msg_dst, msg_event, msg)
		{
			var channel=getChannel(msg).children(" .channelDebug");

			channel.append(
				"<br><b>"+msg["Event"]+"</b><br>"
			);
			for (var msgI in msg)
			{
				if (msgI!="id" && msgI!="serverId" && msgI!="Event")
				{
					channel.append(
						msgI+":"+msg[msgI].replace("<","&lt;").replace(">","&gt;")+"<br>"
					);
				}
			}
			

		});


		function prettyCallerId( callerId, callerIdName)
		{
			var txt="";
			if (callerId!="")
				txt=txt+callerId;
			else
				txt="(unknown number)";

			if (callerIdName!="")
				txt=txt+" '"+callerIdName+"'";

			return txt;					
		}


 		synapse_register("asterisk_updateChannel",function(msg_src, msg_dst, msg_event, msg)
 		{

			var channel=getChannel(msg);

			//set channel status
			$(escapeId(msg["id"])).attr('state', msg["state"]);

			//set caller info
			var callerInfo="";

			//we know who's connected:
			if (msg["linkCallerId"] != '')
			{
				callerInfo+=prettyCallerId(msg["linkCallerId"], msg["linkCallerIdName"]);
			}
			//we dont know whos connected yet, just show extention that is being called
			else
			{
				callerInfo+="Calling "+msg["firstExtension"];
			}

			$(escapeId(msg["id"])+" .channelInfo").html(callerInfo);


// 			//add the update-info to the debug object
// 			$(escapeId(msg["id"])+" .channelDebug").append(
// 				"<br><b>asterisk_updateChannel</b><br>"
// 			);
// 			for (var msgI in msg)
// 			{
// 				if (msgI!="id" )
// 				{
// 					$(escapeId(msg["id"])+" .channelDebug").append(
// 						msgI+"="+msg[msgI]+"<br>"
// 					);
// 				}
// 			}

			//is it the device of the logged in user?
			if (msg["deviceId"]==loginDeviceId)
			{
				if ( msg["state"] == "Ringing" )
				{
					$('#statusMsg').html("Getting called by " +prettyCallerId(msg["linkCallerId"], msg["linkCallerIdName"]));
					$('#statusBar').attr('state', 'ringing');
				}
				else
				{
					$('#statusMsg').html("");
					$('#statusBar').attr('state', '');
				}
			}

		});


 		synapse_register("asterisk_delChannel",function(msg_src, msg_dst, msg_event, msg)
 		{

			$(escapeId(msg["id"])).attr('state', 'deleted');
			//let the channel exist a while after hanging up
			setTimeout(function() { $(escapeId(msg["id"])).remove() } , 300000);

			//is it the device of the logged in user?
			if (msg["deviceId"]==loginDeviceId)
			{
					$('#statusMsg').html("");
					$('#statusBar').attr('state', '');
			}

		});


 		synapse_register("module_SessionEnded",function(msg_src, msg_dst, msg_event, msg)
 		{
		});


		/// JAVA SCRIPT EVENT HANDLERS
		$(document).ready(function(){

			$("#deviceList").sortable();
			$("#deviceList").disableSelection();
			$("#statusLoginUser").click(function()
			{
				send(0,"asterisk_authReq", {});
			});

		});


	</script>

	<style>
		body 
		{
			margin:0;
			padding:0;
			height:100%;
			width: 100%;
		} 

		#statusBar
		{
			background-color: #ddddff;
			height: 5em;
			width: 100%;
			float: left;
			padding: 0.5em;
		}

		#statusBar[state="ringing"]
		{
			background-color: #ffaaaa;
		}


		#statusMsg
		{
			background-color: #ffffff;	
			border-style: none;
			display: inline;
		}

		#statusMsg .error
		{
			color: red;
			font-weigth: bold;
		}
	
		#statusLoginUser
		{
						
			
		}

		#deviceList
		{
			width: 100%;
			float: left;
		}

		.device
		{
			background-color: #CCFFCC;
			float: left;
			border-style:solid;
			width: 20em;
			min-height: 5em;
			margin: 5px;
			padding: 5px;
		}


		.device[state="offline"]
		{
			border-color: #dddddd;
			background-color: #eeeeee;
		}

		.deviceInfo
		{
			border-style:none;
			width:100%;

		}

		.channelList
		{
			border-style:none;
			width:100%;
			min-height: 2em;
		}

		.channel
		{
			border-top-style:dashed;
			border-color:#aaaaaa; 
			border-width: 1px;
			margin:0.3em;
			min-width:15em;
			padding-left:25px;
			background-repeat:no-repeat;
			background-image:url('asterisk/channel_idle.png');
			position:relative;
		}

		.channel[state="in"] 
		{
			background-image:url('asterisk/channel_in.png');
		}

		.channel[state="out"] 
		{
			background-image:url('asterisk/channel_out.png');
		}

		.channel[state="ringing"] 
		{
			background-image:url('asterisk/channel_ring.png');
		}

		.channel[state="deleted"] .channelInfo
		{
			text-decoration: line-through;
			color:#aaaaaa; 
		}

		.channel:hover
		{
			background-color:yellow;
		}

		.channelInfo
		{
			margin:0;
			padding:0;
		}

		.channelDebug
		{
			background-color: #ffffff;
			color: #000000;	
			top: 1.9em;
			left: 1.9em;
			position: absolute;
			border-style: solid;
			z-index:2;
			display:none;
		}

	</style>

</head>


<body>

	<div id='statusBar'>
		Status: <div id='statusMsg'>
			Loading...
		</div>
		<div id='statusLoginUser'>
			(Not logged in)
		</div>
	</div>


	<div id='deviceList'>
	</div>



	
</body>
</html>